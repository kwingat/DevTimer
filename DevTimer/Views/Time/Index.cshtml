@using DevTimer.Helpers
@model DevTimer.Models.WorkListViewModel
@{
    ViewBag.Title = "Time";
    int hours = 0;
}

<div class="caption">
    <i class="fa fa-clock-o"></i>
    Time
</div>
<div class="btn-group"></div>
<div class="btn-group pull-right margin-top-bottom">
    @Html.NoEncodeActionLink("Add New <i class='fa fa-plus'></i>", "Add New", "Create", "Time", null, new { data_modal = "", @class = "btn btn-info" })
    <button class="btn dropdown-toggle" data-toggle="dropdown">
        Options
        <i class="fa fa-angle-down"></i>
    </button>
    <ul class="dropdown-menu pull-right">
        <li><a href="/Time">Export to Excel</a></li>
    </ul>
</div>
<div>
    @foreach (var workday in Model.Works.GroupBy(item => item.StartTime.Value.ToString("MM/dd/yyyy")))
    {
        <div class="">
            <table class="table table-striped table-advance table-hover">
                <thead>
                    <tr style="padding-top: 10px;">
                        <th style="border-top: none; background-color:white;"></th>
                        <th style="font-weight: bold; border-top: none; background-color: white; font-size:18px;">@workday.First().StartTime.Value.ToString("MM/dd/yyyy ddd")</th>
                        <th style="border-top:none; background-color:white; font-size:15px">@workday.Sum(e => e.Hours)<text> Hours</text></th>
                        <th style="border-top:none; background-color:white;"></th>
                    </tr>
                </thead>
                <tbody>

                    @foreach (var work in workday)
                    {
                        <tr style="border-right: #ddd 1px solid; border-left: #ddd 1px solid;">
                            <td class="span3">
                                @work.Project.Name
                            </td>
                            <td class="hidden-phone span8"></td>
                            <td class="span4">
                                @(work.StartTime.HasValue ? work.StartTime.Value.ToShortTimeString() : "")
                                -
                                @if (work.EndTime.HasValue)
                                {
                                    @work.EndTime.Value.ToShortTimeString()<text> </text>
                                    @Html.NoEncodeActionLink("<span class='fa fa-clock-o' > Continue</span>", "Continue", "Continue", "Time", new { id = work.ID }, new { data_modal = "", @class = "btn btn-success" })
                                }
                                else
                                {
                                    @Html.NoEncodeActionLink("<span class='fa fa-clock-o' > Close</span>", "Close", "Close", "Time", new { id = work.ID }, new { @class = "btn btn-warning" })
                                }
                            </td>
                            <td class="span4">
                                <div class="pull-right">
                                    @Html.NoEncodeActionLink("<span class='fa fa-edit' > Edit</span>", "Edit", "Edit", "Time", new { id = @work.ID }, new { data_modal = "", @class = "btn btn-primary" })
                                    @Html.NoEncodeActionLink("<span class='fa fa-trash'> Delete</span>", "Delete", "Delete", "Time", new { id = @work.ID }, new { @class = "btn btn-danger" })
                                </div>
                            </td>
                        </tr>
                        <tr style="background-color: white; border-left: none; border-right: none">
                            <td colspan="4" style="background-color: white; border-left: none; border-right: none"></td>
                        </tr>
                    }

                </tbody>
            </table>
        </div>
    }
</div>

<!-- modal placeholder-->
<div id="myModal" class='modal fade' aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div id='myModalContent'></div>
        </div>
    </div>
</div>

@section scripts
{
    @*@Scripts.Render("~/bundles/jqueryval")*@
    @Scripts.Render("~/bundles/bootstrap-datepicker")

    <script language="javascript">

        $(function() {
            $.ajaxSetup({ cache: false });

            $("a[data-modal]").on("click", function(e) {
                // hide dropdown if any (this is used wehen invoking modal from link in bootstrap dropdown )
                //$(e.target).closest('.btn-group').children('.dropdown-toggle').dropdown('toggle');

                $('#myModalContent').load(this.href, function() {
                    $('#myModal').modal({
                        /*backdrop: 'static',*/
                        keyboard: true
                    }, 'show');

                    bindForm(this);
                });
                return false;
            });
        });

        function pageLoad() {
            
        }

        function bindForm(dialog) {
            $('form', dialog).submit(function() {
                $.ajax({
                    url: this.action,
                    type: this.method,
                    data: $(this).serialize(),
                    success: function(result) {
                        if (result.success) {
                            $('#myModal').modal('hide');

                            // TODO: This line needs to reload the page asyncronously 
                            //$('#replacetarget').load(result.url); //  Load data from the server and place the returned HTML into the matched element

                            location.reload(true);
                        } else {
                            $('#myModalContent').html(result);
                            bindForm(dialog);
                        }
                    }
                });
                return false;
            });
        }


    </script>
}

